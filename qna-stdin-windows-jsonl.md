### Q&A：stdin、COLD/GREEN/RED 窗口 与 JSONL 监控

---

#### Q1：什么是 stdin？在本项目中应该如何理解？
- stdin 是“标准输入流”。在 CCstatus 中，每次由宿主环境（如编辑器/插件）向本进程发送一条 JSON 事件时，程序就从 stdin 读取这条事件并执行一次完整流程。
- 这是一个“事件驱动、无后台线程”的模型：只有收到一条 stdin 事件，系统才会工作一轮；没有新事件就不会主动扫描或探测。

#### Q2：一次 stdin 事件会触发哪些步骤？
- 读取并解析输入 JSON（包含 `session_id`、`transcript_path`、`cwd`、时间信息等）
- 尝试获取凭据（无凭据则写入 Unknown 状态并结束）
- 非 COLD 路径下：扫描 `.jsonl` 尾部以检测 API 错误（429/5xx 等）
- 计算窗口并决策：按优先级 COLD > RED > GREEN，仅执行一种 probe
- 执行 probe（若有）并写入状态文件
- 渲染状态文本到 stdout

#### Q3：什么是 COLD/GREEN/RED 窗口？各自何时触发？
- COLD（最高优先级）
  - 触发：状态无效（Unknown）或 `total_duration_ms` 小于阈值（默认约 5000ms）
  - 特性：用于会话启动阶段；命中 COLD 时不再评估 RED/GREEN；会话内去重
- RED（中优先级，错误驱动）
  - 触发：当前事件时间点位于每 10 秒窗口的前 1 秒内，即 `(total_duration_ms % 10_000) < 1_000`，并且本次事件扫描 JSONL 检测到错误
  - 频率：最多每 10 秒一次（同一 RED 窗口内去重）
  - 目的：错误发生时进行快速诊断
- GREEN（最低优先级，常规健康）
  - 触发：当前事件时间点位于每 5 分钟窗口的前 3 秒内，即 `(total_duration_ms % 300_000) < 3_000`
  - 频率：每 5 分钟一次（同一 GREEN 窗口内去重）
  - 目的：基线健康检查与 P95 统计

#### Q4：JSONL 监控是“实时”的吗？
- 不是持续后台线程；它只在收到一条 stdin 事件时扫描 `.jsonl` 尾部一次（非 COLD 路径）。因此如果没有新事件到来，就不会进行新的扫描。

#### Q5：如果我没有任何输入操作，屏幕上出现了 API Error（例如 429/502），会发生什么？
- 当下不会立即响应，因为系统是事件驱动的。
- 当下一次 stdin 事件到来时：
  - 如果该事件处于 RED 时间片，并且扫描到该错误，则会触发 RED 探测（更高频率）。
  - 如果不在 RED 时间片，或本次扫描未检测到错误，则不会触发 RED。

#### Q6：JSONL 监控何时参与决策？
- 仅在非 COLD 路径下、且在本次 stdin 事件处理时扫描一次。扫描结果（是否检测到错误，以及最后错误事件）会用于 RED 窗口的触发判断。

#### Q7：为什么只在 RED 时间片内才触发 RED？
- 为了避免后台轮询和过度探测，系统采用“窗口 + 去重”的节流策略：
  - 仅在固定时间片评估是否需要快速诊断（RED）
  - 同一时间片内只执行一次（去重），降低噪声与开销

#### Q8：GREEN 与 JSONL 错误有什么关系？
- GREEN 与错误无直接依赖。即使没有错误，只要命中 GREEN 时间片且未被 COLD/RED 抢占，就会进行一次常规健康探测用于统计。

#### Q9：去重机制如何工作？
- GREEN：使用 `last_green_window_id`，命中同一 5 分钟窗口的重复事件会跳过
- RED：使用 `last_red_window_id`，命中同一 10 秒窗口的重复事件会跳过
- COLD：使用会话 `session_id` 去重，避免同一会话重复 COLD 探测

#### Q10：为何采用事件驱动 + 窗口设计？
- 避免常驻后台线程和无谓网络流量
- 统一由宿主环境的事件节奏驱动，便于控制与集成
- 窗口 + 去重在确保可观测性的同时，限制了探测频率与成本

#### Q11：几个常见误解
- 误解：“JSONL 监控会实时触发 RED”
  - 事实：只有在下一次 stdin 事件到来时才会扫描；且必须命中 RED 时间片并检测到错误才会触发
- 误解：“没有输入也会自动探测”
  - 事实：不会。无事件就无探测

#### Q12：术语速览
- stdin：标准输入流；一次 JSON 事件输入
- COLD：启动期窗口（优先级最高）
- RED：错误驱动窗口（10 秒一片，片头 1 秒）
- GREEN：常规健康窗口（5 分钟一片，片头 3 秒）
- JSONL 监控：对对话转录 `.jsonl` 的尾部扫描（仅在事件处理时）
